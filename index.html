<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliado Pro - Versão Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="manutencao-screen" class="hidden fixed inset-0 bg-slate-900 z-[9999] flex items-center justify-center text-center p-6 text-white">
        <div>
            <i class="fas fa-tools text-6xl mb-6 text-orange-500 animate-bounce"></i>
            <h1 class="text-4xl font-black">SISTEMA EM MANUTENÇÃO</h1>
            <p class="mt-4 text-slate-400">O proprietário está realizando melhorias. Voltamos em breve!</p>
        </div>
    </div>

    <div id="login-screen" class="flex min-h-screen items-center justify-center bg-slate-100">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl text-center w-full max-w-md border">
            <h1 class="text-4xl font-black mb-8 italic">AFILIADO<span class="text-blue-600">PRO</span></h1>
            <button onclick="loginGoogle()" class="w-full bg-slate-900 text-white flex items-center justify-center py-4 rounded-2xl font-bold hover:bg-black transition shadow-xl">
                <i class="fab fa-google mr-3"></i> Entrar com Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <aside class="w-full md:w-72 bg-slate-900 text-white p-6 flex flex-col">
            <div class="flex flex-col items-center pb-8 border-b border-slate-800 mb-6 text-center">
                <img id="user-photo" src="" class="w-20 h-20 rounded-2xl mb-4 border-2 border-blue-500 p-1 object-cover shadow-lg">
                <h3 id="user-name" class="font-bold"></h3>
                <div id="user-status-sidebar" class="mt-2 text-[10px] font-black px-3 py-1 rounded-lg uppercase bg-blue-600 tracking-wider"></div>
            </div>

            <nav class="space-y-2 flex-1">
                <button onclick="showTab('home')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 transition font-bold"><i class="fas fa-store mr-3"></i> Mercado</button>
                <button onclick="showTab('afiliacoes')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 transition font-bold"><i class="fas fa-link mr-3 text-emerald-400"></i> Meus Links</button>
                <button id="btn-admin-master" onclick="showTab('admin-master')" class="hidden w-full text-left p-4 rounded-2xl bg-red-600 text-white hover:bg-red-700 transition font-bold shadow-lg"><i class="fas fa-crown mr-3"></i> Painel Mestre</button>
                <button onclick="showTab('config')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 transition font-bold"><i class="fas fa-user-circle mr-3"></i> Meu Perfil</button>
            </nav>
            <button onclick="logout()" class="p-4 text-slate-500 hover:text-white font-bold transition">Sair da Conta</button>
        </aside>

        <main class="flex-1 p-8 lg:p-12 overflow-y-auto">
            
            <section id="tab-home">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-4xl font-black text-slate-800">Mercado</h2>
                    <button id="btn-abrir-cadastro" onclick="toggleForm()" class="hidden bg-blue-600 text-white px-6 py-3 rounded-2xl font-black hover:bg-blue-700 transition shadow-lg flex items-center gap-2">
                        <i class="fas fa-plus"></i> Novo Produto
                    </button>
                </div>
                
                <div id="admin-panel" class="hidden bg-white p-8 rounded-[35px] shadow-xl border border-slate-200 mb-12 animate-in fade-in duration-300">
                    <h3 class="text-xl font-bold mb-6 italic">Postar Produto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="prod-nome" type="text" placeholder="Nome do Produto" class="p-4 bg-slate-50 rounded-2xl border outline-none focus:border-blue-500">
                        <input id="prod-preco" type="number" placeholder="Preço Sugerido (R$)" class="p-4 bg-slate-50 rounded-2xl border outline-none focus:border-blue-500">
                        <input id="prod-thumb" type="text" placeholder="URL da Foto do Produto" class="p-4 bg-slate-50 rounded-2xl border outline-none focus:border-blue-500">
                        <input id="prod-link" type="text" placeholder="Link do Site de Afiliado" class="p-4 bg-slate-50 rounded-2xl border outline-none focus:border-blue-500">
                        <textarea id="prod-desc" placeholder="Breve descrição..." class="p-4 bg-slate-50 rounded-2xl border outline-none focus:border-blue-500 md:col-span-2 h-24"></textarea>
                        <button onclick="salvarProduto()" class="md:col-span-2 bg-slate-900 text-white py-4 rounded-2xl font-black hover:bg-black transition">POSTAR AGORA</button>
                    </div>
                </div>

                <div id="grid-produtos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </section>

            <section id="tab-afiliacoes" class="hidden">
                <h2 class="text-4xl font-black mb-10">Minhas Afiliações</h2>
                <div id="lista-afiliacoes" class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3"></div>
            </section>

            <section id="tab-admin-master" class="hidden">
                <h2 class="text-4xl font-black text-red-600 mb-10">Controle de Usuários</h2>
                
                <div class="flex gap-4 mb-10">
                    <button onclick="setManutencao(true)" class="bg-orange-500 text-white px-6 py-3 rounded-2xl font-black shadow-lg">LIGAR MANUTENÇÃO</button>
                    <button onclick="setManutencao(false)" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black shadow-lg">SISTEMA NORMAL</button>
                </div>

                <div class="bg-white rounded-[35px] border shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr class="text-[10px] text-slate-400 uppercase font-black tracking-widest">
                                <th class="p-6">Usuário</th>
                                <th class="p-6 text-center">Nível</th>
                                <th class="p-6 text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="lista-gestao-cargos" class="divide-y"></tbody>
                    </table>
                </div>
            </section>

            <section id="tab-config" class="hidden">
                <h2 class="text-4xl font-black mb-10">Meu Perfil</h2>
                <div id="perfil-card" class="bg-white p-10 rounded-[40px] border shadow-sm max-w-xl flex items-center gap-8"></div>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, setDoc, getDoc, query, where, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhebhWNET0qK1yA09WYiGayg2vp6fZtmE",
            authDomain: "site-administrativo.firebaseapp.com",
            projectId: "site-administrativo",
            storageBucket: "site-administrativo.firebasestorage.app",
            messagingSenderId: "168715430420",
            appId: "1:168715430420:web:17c799ab344c008c4dd501"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const RAFAEL_EMAIL = "rafaelmartinsdosanjos27@gmail.com";

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());
        window.toggleForm = () => document.getElementById('admin-panel').classList.toggle('hidden');
        window.showTab = (name) => {
            ['home', 'afiliacoes', 'config', 'admin-master'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
        };

        // --- FUNÇÕES MESTRE ---
        window.setManutencao = async (val) => {
            if(confirm("Alterar status do sistema?")) {
                await setDoc(doc(db, "configuracoes", "geral"), { status: val });
                alert("Sistema Atualizado!");
            }
        };

        window.confirmarMudancaCargo = async (uid, nome, novoCargo) => {
            if(confirm(`Mudar ${nome} para ${novoCargo.toUpperCase()}?`)) {
                await updateDoc(doc(db, "usuarios", uid), { cargo: novoCargo });
                alert("Cargo alterado!");
            }
        };

        window.confirmarBan = async (uid, nome, status) => {
            const msg = status ? "BANIR E EXPULSAR" : "DESBANIR";
            if(confirm(`Deseja ${msg} ${nome}?`)) {
                await updateDoc(doc(db, "usuarios", uid), { banido: status });
                alert("Usuário atualizado!");
            }
        };

        window.removerProduto = async (id) => {
            if(confirm("Apagar este produto do mercado definitivamente?")) {
                await deleteDoc(doc(db, "produtos", id));
            }
        };

        // --- SISTEMA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "usuarios", user.uid);
                
                // Força Criador se for você
                if (user.email === RAFAEL_EMAIL) {
                    await setDoc(userRef, { nome: user.displayName, email: user.email, cargo: "criador", photo: user.photoURL, banido: false }, { merge: true });
                }

                const snap = await getDoc(userRef);
                if(!snap.exists()) {
                    await setDoc(userRef, { nome: user.displayName, email: user.email, cargo: "minimo", photo: user.photoURL, banido: false });
                }
                
                const userData = (await getDoc(userRef)).data();

                // Check de Banimento
                if(userData.banido) {
                    alert("VOCÊ FOI BANIDO POR UM ADMINISTRADOR.");
                    logout();
                    return;
                }

                // Check de Manutenção
                onSnapshot(doc(db, "configuracoes", "geral"), s => {
                    if(s.exists() && s.data().status && user.email !== RAFAEL_EMAIL) {
                        document.getElementById('manutencao-screen').classList.remove('hidden');
                    } else {
                        document.getElementById('manutencao-screen').classList.add('hidden');
                    }
                });

                // INTERFACE
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                document.getElementById('user-status-sidebar').innerText = userData.cargo;

                // PERFIL
                document.getElementById('perfil-card').innerHTML = `
                    <img src="${user.photoURL}" class="w-24 h-24 rounded-full border-4 border-blue-500 shadow-xl">
                    <div class="text-left">
                        <h3 class="text-2xl font-black">${user.displayName}</h3>
                        <p class="text-slate-400 font-medium">${user.email}</p>
                        <span class="mt-2 inline-block px-4 py-1 bg-blue-100 text-blue-600 rounded-lg font-black text-[10px] border border-blue-200 uppercase">${userData.cargo}</span>
                    </div>`;

                // LIBERAR FERRAMENTAS
                if(['criador', 'admin', 'verificado'].includes(userData.cargo)) {
                    document.getElementById('btn-abrir-cadastro').classList.remove('hidden');
                }

                if(['criador', 'admin'].includes(userData.cargo)) {
                    document.getElementById('btn-admin-master').classList.remove('hidden');
                    
                    // Lista de Usuários no Painel
                    onSnapshot(collection(db, "usuarios"), s => {
                        const l = document.getElementById('lista-gestao-cargos');
                        l.innerHTML = "";
                        s.forEach(d => {
                            const u = d.data();
                            if(u.email === RAFAEL_EMAIL) return; // Não gerencia a si mesmo
                            l.innerHTML += `
                                <tr class="border-b">
                                    <td class="p-6">
                                        <span class="font-bold text-slate-800">${u.nome}</span><br>
                                        <span class="text-[10px] text-slate-400">${u.email}</span>
                                    </td>
                                    <td class="p-6 text-center">
                                        <span class="px-2 py-1 bg-slate-100 rounded text-[9px] font-black uppercase border">${u.cargo}</span>
                                    </td>
                                    <td class="p-6 text-right flex gap-2 justify-end">
                                        <select onchange="confirmarMudancaCargo('${d.id}', '${u.nome}', this.value)" class="text-[10px] border rounded-lg p-1 bg-white outline-none">
                                            <option value="minimo" ${u.cargo==='minimo'?'selected':''}>MÍNIMO</option>
                                            <option value="verificado" ${u.cargo==='verificado'?'selected':''}>VERIFICADO</option>
                                            <option value="suport" ${u.cargo==='suport'?'selected':''}>SUPORTE</option>
                                            <option value="admin" ${u.cargo==='admin'?'selected':''}>ADMIN</option>
                                        </select>
                                        <button onclick="confirmarBan('${d.id}', '${u.nome}', ${!u.banido})" class="px-3 py-1 rounded-lg font-black text-[10px] ${u.banido?'bg-green-500 text-white':'bg-red-500 text-white'}">
                                            ${u.banido?'VOLTAR':'EXPULSAR'}
                                        </button>
                                    </td>
                                </tr>`;
                        });
                    });
                }

                // MERCADO + QUEM POSTOU
                onSnapshot(collection(db, "produtos"), s => {
                    const g = document.getElementById('grid-produtos'); g.innerHTML = "";
                    s.forEach(d => {
                        const p = d.data();
                        const canDelete = (userData.cargo === 'criador' || userData.cargo === 'admin');
                        g.innerHTML += `
                            <div class="bg-white rounded-[35px] border shadow-sm overflow-hidden relative group hover:shadow-xl transition-all">
                                ${canDelete ? `<button onclick="removerProduto('${d.id}')" class="absolute top-4 right-4 bg-red-600 text-white w-8 h-8 rounded-full shadow-lg z-10"><i class="fas fa-trash-alt text-[10px]"></i></button>` : ''}
                                <img src="${p.thumb || 'https://via.placeholder.com/400x300'}" class="h-48 w-full object-cover">
                                <div class="p-6 text-left">
                                    <div class="flex items-center gap-2 mb-4">
                                        <img src="${p.autorFoto || ''}" class="w-6 h-6 rounded-full border">
                                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${p.autorNome || 'Vendedor'}</span>
                                    </div>
                                    <h4 class="font-black text-xl mb-1">${p.nome}</h4>
                                    <p class="text-slate-400 text-[10px] mb-4 line-clamp-2">${p.desc || 'Sem descrição.'}</p>
                                    <div class="flex justify-between items-end mb-6">
                                        <div><p class="text-[8px] font-black text-blue-500 uppercase">Preço</p><p class="font-black text-xl text-slate-800 italic">R$ ${p.preco}</p></div>
                                    </div>
                                    <button onclick="seAfiliar('${d.id}', '${p.nome}', '${p.link}')" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-sm active:scale-95 transition">SOLICITAR AFILIAÇÃO</button>
                                </div>
                            </div>`;
                    });
                });

                // MEUS LINKS
                onSnapshot(query(collection(db, "afiliacoes"), where("emailAfiliado", "==", user.email)), s => {
                    const c = document.getElementById('lista-afiliacoes'); c.innerHTML = "";
                    s.forEach(d => {
                        const l = d.data();
                        c.innerHTML += `
                            <div class="bg-white p-6 rounded-3xl border shadow-sm text-left">
                                <h4 class="font-black mb-2 text-lg">${l.produtoNome}</h4>
                                <div class="p-3 bg-slate-50 rounded-xl border text-[10px] font-mono mb-4 text-blue-600 break-all select-all">${l.produtoLink}</div>
                                <a href="${l.produtoLink}" target="_blank" class="block w-full text-center bg-emerald-500 text-white py-4 rounded-2xl font-black text-xs hover:bg-emerald-600 transition">ABRIR SITE DO PRODUTO</a>
                            </div>`;
                    });
                });

            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        // --- AÇÕES DO USUÁRIO ---
        window.salvarProduto = async () => {
            const f = { 
                nome: document.getElementById('prod-nome').value, 
                preco: document.getElementById('prod-preco').value, 
                thumb: document.getElementById('prod-thumb').value, 
                link: document.getElementById('prod-link').value, 
                desc: document.getElementById('prod-desc').value, 
                autorNome: auth.currentUser.displayName, 
                autorFoto: auth.currentUser.photoURL,
                autorEmail: auth.currentUser.email
            };
            if(!f.nome || !f.link) return alert("Nome e Link são obrigatórios!");
            await addDoc(collection(db, "produtos"), f);
            alert("Produto Publicado!");
            toggleForm();
            document.querySelectorAll('#admin-panel input, #admin-panel textarea').forEach(i => i.value = "");
        };

        window.seAfiliar = async (id, nome, link) => {
            const q = query(collection(db, "afiliacoes"), where("emailAfiliado", "==", auth.currentUser.email), where("produtoId", "==", id));
            const existe = await getDocs(q);
            if(!existe.empty) return alert("Você já é afiliado deste produto!");

            await addDoc(collection(db, "afiliacoes"), { 
                emailAfiliado: auth.currentUser.email, 
                produtoId: id, 
                produtoNome: nome, 
                produtoLink: link,
                data: new Date()
            });
            alert("Afiliação concluída! Veja na aba 'Meus Links'.");
        };

    </script>
</body>
</html>