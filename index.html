<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliado Pro - Painel Mestre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div id="manutencao-screen" class="hidden fixed inset-0 bg-slate-900 z-[9999] flex items-center justify-center text-white text-center p-6">
        <div><i class="fas fa-tools text-6xl text-orange-500 mb-4 animate-bounce"></i><h1 class="text-3xl font-black uppercase">Sistema em Manutenção</h1><p class="text-slate-400">O Criador está ajustando o servidor. Voltamos logo!</p></div>
    </div>

    <div id="login-screen" class="flex min-h-screen items-center justify-center bg-slate-100">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl text-center w-full max-w-md border">
            <h1 class="text-4xl font-black mb-8 italic text-slate-800">AFILIADO<span class="text-blue-600">PRO</span></h1>
            <button onclick="loginGoogle()" class="w-full bg-slate-900 text-white flex items-center justify-center py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition">
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <aside class="w-full md:w-72 bg-slate-900 text-white p-6 flex flex-col">
            <div class="flex flex-col items-center pb-8 border-b border-slate-800 mb-6 text-center">
                <img id="user-photo" src="" class="w-20 h-20 rounded-2xl mb-4 border-2 border-blue-500 p-1 object-cover">
                <h3 id="user-name" class="font-bold"></h3>
                <div id="user-status-sidebar" class="mt-2 text-[10px] font-black px-3 py-1 rounded-lg uppercase bg-blue-600"></div>
            </div>
            <nav class="space-y-2 flex-1">
                <button onclick="showTab('home')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 font-bold transition"><i class="fas fa-store mr-3"></i> Mercado</button>
                <button onclick="showTab('afiliacoes')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 font-bold transition"><i class="fas fa-link mr-3 text-emerald-400"></i> Meus Links</button>
                <button id="btn-admin-master" onclick="showTab('admin-master')" class="hidden w-full text-left p-4 rounded-2xl bg-red-600 font-bold transition"><i class="fas fa-crown mr-3"></i> Painel Mestre</button>
                <button onclick="showTab('config')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 font-bold transition"><i class="fas fa-user mr-3"></i> Perfil</button>
            </nav>
            <button onclick="logout()" class="p-4 text-slate-500 hover:text-white font-bold transition">Sair</button>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <section id="tab-home">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-4xl font-black">Mercado</h2>
                    <button id="btn-abrir-cadastro" onclick="toggleForm()" class="hidden bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold">+ Novo Produto</button>
                </div>
                <div id="admin-panel" class="hidden bg-white p-8 rounded-[30px] border mb-8 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="prod-nome" placeholder="Nome do Produto" class="p-4 bg-slate-50 rounded-xl border outline-none focus:border-blue-500">
                        <input id="prod-preco" placeholder="Preço Sugerido (R$)" class="p-4 bg-slate-50 rounded-xl border outline-none focus:border-blue-500">
                        <input id="prod-thumb" placeholder="URL da Foto do Produto" class="p-4 bg-slate-50 rounded-xl border outline-none focus:border-blue-500">
                        <input id="prod-link" placeholder="Link de Afiliado (Site)" class="p-4 bg-slate-50 rounded-xl border outline-none focus:border-blue-500">
                        <textarea id="prod-desc" placeholder="Descrição curta..." class="p-4 bg-slate-50 rounded-xl border outline-none md:col-span-2 h-20"></textarea>
                        <button onclick="salvarProduto()" class="md:col-span-2 bg-slate-900 text-white py-4 rounded-xl font-bold">PUBLICAR NO MERCADO</button>
                    </div>
                </div>
                <div id="grid-produtos" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </section>

            <section id="tab-afiliacoes" class="hidden">
                <h2 class="text-4xl font-black mb-10">Meus Links de Afiliado</h2>
                <div id="lista-afiliacoes" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </section>

            <section id="tab-config" class="hidden">
                <h2 class="text-4xl font-black mb-10 text-slate-800">Meu Perfil</h2>
                <div id="perfil-card" class="bg-white p-10 rounded-[40px] border shadow-sm max-w-xl flex items-center gap-8"></div>
            </section>

            <section id="tab-admin-master" class="hidden">
                <h2 class="text-4xl font-black text-red-600 mb-8">Gestão de Sistema</h2>
                <div class="flex flex-wrap gap-4 mb-8">
                    <button onclick="setManutencao(true)" class="bg-orange-500 text-white px-6 py-3 rounded-xl font-black shadow-lg">ATIVAR MANUTENÇÃO</button>
                    <button onclick="setManutencao(false)" class="bg-emerald-500 text-white px-6 py-3 rounded-xl font-black shadow-lg">SISTEMA NORMAL</button>
                </div>
                <div class="bg-white rounded-[30px] border overflow-hidden shadow-xl">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b font-black text-[10px] text-slate-400 uppercase tracking-widest">
                            <tr><th class="p-6">Usuário</th><th class="p-6">Cargo</th><th class="p-6 text-right">Ação</th></tr>
                        </thead>
                        <tbody id="lista-gestao-cargos" class="divide-y"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, setDoc, getDoc, query, where, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhebhWNET0qK1yA09WYiGayg2vp6fZtmE",
            authDomain: "site-administrativo.firebaseapp.com",
            projectId: "site-administrativo",
            storageBucket: "site-administrativo.firebasestorage.app",
            messagingSenderId: "168715430420",
            appId: "1:168715430420:web:17c799ab344c008c4dd501"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const MESTRE = "rafaelmartinsdosanjos27@gmail.com";

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);
        window.toggleForm = () => document.getElementById('admin-panel').classList.toggle('hidden');
        window.showTab = (name) => {
            ['home', 'afiliacoes', 'config', 'admin-master'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
        };

        // GESTÃO
        window.removerProduto = async (id) => { if(confirm("Apagar produto?")) await deleteDoc(doc(db, "produtos", id)); };
        window.setManutencao = async (v) => await setDoc(doc(db, "configuracoes", "geral"), { status: v });
        window.banirUser = async (uid, status) => { await updateDoc(doc(db, "usuarios", uid), { banido: status }); };

        onSnapshot(doc(db, "configuracoes", "geral"), snap => {
            if(snap.exists() && snap.data().status && auth.currentUser?.email !== MESTRE) {
                document.getElementById('manutencao-screen').classList.remove('hidden');
            } else { document.getElementById('manutencao-screen').classList.add('hidden'); }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "usuarios", user.uid);
                if(user.email === MESTRE) await setDoc(userRef, { nome: user.displayName, email: user.email, cargo: "criador", photo: user.photoURL }, { merge: true });
                
                const snap = await getDoc(userRef);
                const uData = snap.data() || { cargo: "minimo", banido: false };

                if(uData.banido) { alert("VOCÊ FOI EXPULSO DO SISTEMA."); logout(); return; }

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                document.getElementById('user-status-sidebar').innerText = uData.cargo;

                // PERFIL
                document.getElementById('perfil-card').innerHTML = `<img src="${user.photoURL}" class="w-24 h-24 rounded-full border-4 border-blue-500 shadow-xl"><div class="flex-1 text-left"><h3 class="text-2xl font-black">${user.displayName}</h3><p class="text-slate-400 font-medium">${user.email}</p><span class="mt-2 inline-block px-4 py-1 bg-blue-100 text-blue-600 rounded-lg font-black text-[10px] uppercase border border-blue-200">${uData.cargo}</span></div>`;

                if(['criador', 'admin', 'verificado'].includes(uData.cargo)) document.getElementById('btn-abrir-cadastro').classList.remove('hidden');
                
                // PAINEL MESTRE (BANIR, KICK, CARGOS)
                if(['criador', 'admin'].includes(uData.cargo)) {
                    document.getElementById('btn-admin-master').classList.remove('hidden');
                    onSnapshot(collection(db, "usuarios"), s => {
                        const l = document.getElementById('lista-gestao-cargos'); l.innerHTML = "";
                        s.forEach(d => {
                            const usr = d.data();
                            l.innerHTML += `<tr class="border-b"><td class="p-6"><span class="font-black text-sm">${usr.nome}</span><br><span class="text-slate-400 text-xs">${usr.email}</span></td>
                                <td class="p-6"><span class="px-2 py-1 bg-slate-100 rounded text-[9px] font-black border uppercase">${usr.cargo}</span></td>
                                <td class="p-6 text-right flex gap-2 justify-end">
                                    <select onchange="updateDoc(doc(db, 'usuarios', '${d.id}'), {cargo: this.value})" class="text-[10px] border rounded-lg p-1 bg-white outline-none">
                                        <option value="minimo" ${usr.cargo==='minimo'?'selected':''}>MÍNIMO</option>
                                        <option value="verificado" ${usr.cargo==='verificado'?'selected':''}>VERIFICADO</option>
                                        <option value="suport" ${usr.cargo==='suport'?'selected':''}>SUPORTE</option>
                                        <option value="admin" ${usr.cargo==='admin'?'selected':''}>ADMIN</option>
                                    </select>
                                    <button onclick="banirUser('${d.id}', ${!usr.banido})" class="px-3 py-1 rounded-lg font-black text-[10px] ${usr.banido?'bg-green-500 text-white':'bg-red-500 text-white'}">${usr.banido?'VOLTAR':'EXPULSAR'}</button>
                                </td></tr>`;
                        });
                    });
                }

                // PRODUTOS + QUEM POSTOU + REMOVER
                onSnapshot(collection(db, "produtos"), s => {
                    const g = document.getElementById('grid-produtos'); g.innerHTML = "";
                    s.forEach(d => {
                        const p = d.data();
                        const canDelete = (uData.cargo === 'criador' || uData.cargo === 'admin');
                        g.innerHTML += `<div class="bg-white rounded-[35px] border shadow-sm overflow-hidden relative">
                            ${canDelete ? `<button onclick="removerProduto('${d.id}')" class="absolute top-4 right-4 bg-red-600 text-white w-8 h-8 rounded-full shadow-lg hover:scale-110 transition"><i class="fas fa-trash-alt text-[10px]"></i></button>` : ''}
                            <img src="${p.thumb}" class="h-44 w-full object-cover">
                            <div class="p-6">
                                <div class="flex items-center gap-2 mb-4"><img src="${p.autorFoto || ''}" class="w-6 h-6 rounded-full border"><span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${p.autorNome || 'Anônimo'}</span></div>
                                <h4 class="font-black text-xl mb-1">${p.nome}</h4>
                                <p class="text-slate-400 text-[10px] mb-4 line-clamp-2">${p.desc || ''}</p>
                                <button onclick="seAfiliar('${d.id}', '${p.nome}', '${p.link}')" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-sm active:scale-95 transition">SE AFILIAR</button>
                            </div></div>`;
                    });
                });

                // MEUS LINKS
                onSnapshot(query(collection(db, "afiliacoes"), where("emailAfiliado", "==", user.email)), s => {
                    const c = document.getElementById('lista-afiliacoes'); c.innerHTML = "";
                    s.forEach(d => {
                        const l = d.data();
                        c.innerHTML += `<div class="bg-white p-6 rounded-3xl border shadow-sm"><h4 class="font-black mb-2">${l.produtoNome}</h4><div class="p-3 bg-slate-50 rounded-xl border text-[10px] font-mono mb-4 text-blue-600 break-all select-all">${l.produtoLink}</div><a href="${l.produtoLink}" target="_blank" class="block w-full text-center bg-emerald-500 text-white py-3 rounded-2xl font-black text-xs">ABRIR SITE</a></div>`;
                    });
                });
            } else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('dashboard').classList.add('hidden'); }
        });

        window.salvarProduto = async () => {
            const f = { nome: document.getElementById('prod-nome').value, preco: document.getElementById('prod-preco').value, thumb: document.getElementById('prod-thumb').value, link: document.getElementById('prod-link').value, desc: document.getElementById('prod-desc').value, autorNome: auth.currentUser.displayName, autorFoto: auth.currentUser.photoURL };
            if(!f.nome || !f.link) return alert("Preencha o básico!");
            await addDoc(collection(db, "produtos"), f); alert("Postado!"); toggleForm();
        };

        window.seAfiliar = async (id, nome, link) => {
            const q = query(collection(db, "afiliacoes"), where("emailAfiliado", "==", auth.currentUser.email), where("produtoId", "==", id));
            if(!(await getDocs(q)).empty) return alert("Já é afiliado!");
            await addDoc(collection(db, "afiliacoes"), { emailAfiliado: auth.currentUser.email, produtoId: id, produtoNome: nome, produtoLink: link });
            alert("Salvo em Meus Links!");
        };
    </script>
</body>
</html>