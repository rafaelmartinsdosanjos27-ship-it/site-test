<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliado Pro - Sistema Mestre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sidebar-active { background: #1e293b; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div id="overlay-manutencao" class="hidden fixed inset-0 bg-slate-900 z-[9999] flex items-center justify-center text-center p-6 text-white">
        <div>
            <i class="fas fa-tools text-6xl mb-6 text-orange-500 animate-bounce"></i>
            <h1 class="text-4xl font-black">SISTEMA EM MANUTENÇÃO</h1>
            <p class="text-slate-400 mt-4">Aguarde alguns instantes enquanto atualizamos o servidor.</p>
        </div>
    </div>

    <div id="login-screen" class="flex min-h-screen items-center justify-center bg-slate-100">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl text-center w-full max-w-md border border-slate-200">
            <h1 class="text-4xl font-black mb-2 text-slate-800 italic tracking-tighter">AFILIADO<span class="text-blue-600">PRO</span></h1>
            <p class="text-slate-400 mb-8 font-medium">Plataforma Exclusiva de Afiliações</p>
            <button onclick="loginGoogle()" class="w-full bg-slate-900 text-white flex items-center justify-center px-4 py-4 rounded-2xl hover:bg-black transition-all shadow-xl font-bold active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 mr-3 bg-white p-0.5 rounded-full"> 
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <aside class="w-full md:w-72 bg-slate-900 text-white p-6 flex flex-col shadow-2xl">
            <div class="flex flex-col items-center pb-8 border-b border-slate-800 mb-6 text-center">
                <img id="user-photo" src="" class="w-20 h-20 rounded-3xl shadow-lg mb-4 object-cover border-2 border-blue-500/50 p-1">
                <h3 id="user-name" class="font-bold text-lg leading-tight">Carregando...</h3>
                <div id="user-status-sidebar" class="mt-2 text-[10px] font-black px-3 py-1 rounded-lg uppercase tracking-wider"></div>
            </div>

            <nav class="space-y-2 flex-1">
                <button onclick="showTab('home')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 transition font-bold"><i class="fas fa-store mr-3 text-blue-400"></i> Mercado</button>
                <button onclick="showTab('afiliacoes')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 transition font-bold"><i class="fas fa-handshake mr-3 text-emerald-400"></i> Minhas Vendas</button>
                <button id="btn-admin-master" onclick="showTab('admin-master')" class="hidden w-full text-left p-4 rounded-2xl bg-red-600/10 text-red-400 hover:bg-red-600/20 transition font-bold border border-red-600/20"><i class="fas fa-crown mr-3"></i> Painel Mestre</button>
                <button onclick="showTab('config')" class="w-full text-left p-4 rounded-2xl hover:bg-slate-800 transition font-bold"><i class="fas fa-user-circle mr-3 text-purple-400"></i> Perfil</button>
            </nav>

            <button onclick="logout()" class="mt-10 p-4 text-slate-500 hover:text-red-400 font-bold transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Sair do Sistema
            </button>
        </aside>

        <main class="flex-1 p-8 lg:p-12 overflow-y-auto">
            
            <section id="tab-home">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-4xl font-black text-slate-800 tracking-tight">Produtos</h2>
                </div>
                
                <div id="admin-panel" class="hidden bg-white p-8 rounded-[35px] shadow-sm border border-slate-200 mb-12">
                    <h3 class="text-xl font-bold mb-6 text-slate-700 flex items-center"><i class="fas fa-plus-circle mr-2 text-blue-500"></i> Cadastrar Novo Infoproduto</h3>
                    <div class="flex flex-wrap gap-4">
                        <input id="prod-nome" type="text" placeholder="Nome do produto" class="flex-1 min-w-[250px] p-4 bg-slate-50 rounded-2xl outline-none border focus:border-blue-500 transition">
                        <input id="prod-preco" type="number" placeholder="Preço" class="w-32 p-4 bg-slate-50 rounded-2xl outline-none border focus:border-blue-500 transition">
                        <button onclick="salvarProduto()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black hover:bg-blue-700 transition shadow-lg shadow-blue-200">PUBLICAR</button>
                    </div>
                </div>

                <div id="grid-produtos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
            </section>

            <section id="tab-admin-master" class="hidden">
                <h2 class="text-4xl font-black text-red-600 mb-10">Controle Mestre</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <div class="bg-white p-8 rounded-[35px] border-2 border-orange-100 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-toggle-on text-orange-500"></i> Manutenção do Sistema</h3>
                        <p class="text-sm text-slate-400 mb-6">Ao ativar, todos os usuários (exceto você) serão bloqueados.</p>
                        <div class="flex gap-4">
                            <button onclick="alternarManutencao(true)" class="flex-1 bg-orange-500 text-white py-4 rounded-2xl font-black hover:bg-orange-600 transition">ATIVAR</button>
                            <button onclick="alternarManutencao(false)" class="flex-1 bg-emerald-500 text-white py-4 rounded-2xl font-black hover:bg-emerald-600 transition">NORMALIZAR</button>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[35px] border-2 border-red-100 shadow-sm text-center">
                        <h3 class="font-bold text-slate-800 mb-4">Gerenciamento de Membros</h3>
                        <p class="text-sm text-slate-400 mb-4 italic text-center">Mude os cargos para dar acesso a novos criadores.</p>
                        <i class="fas fa-users text-4xl text-slate-200"></i>
                    </div>
                </div>

                <div class="bg-white rounded-[35px] border shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr class="text-[10px] text-slate-400 uppercase tracking-widest font-black">
                                <th class="p-6">Usuário</th>
                                <th class="p-6">Nível Atual</th>
                                <th class="p-6 text-right">Mudar Nível</th>
                            </tr>
                        </thead>
                        <tbody id="lista-gestao-cargos" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <section id="tab-afiliacoes" class="hidden"><h2 class="text-4xl font-black mb-10 text-slate-800 tracking-tight">Minhas Afiliações</h2><div id="lista-afiliacoes" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3"></div></section>
            
            <section id="tab-config" class="hidden">
                <h2 class="text-4xl font-black mb-10 text-slate-800">Meu Perfil</h2>
                <div class="bg-white p-10 rounded-[40px] border max-w-2xl shadow-sm border-slate-200">
                    <div class="flex items-center gap-8 mb-8">
                        <img id="conf-photo" src="" class="w-24 h-24 rounded-[30px] shadow-2xl border-4 border-white ring-2 ring-slate-100">
                        <div><h3 id="conf-name" class="text-3xl font-black text-slate-800"></h3><p id="conf-email" class="text-slate-400 text-lg"></p></div>
                    </div>
                    <div class="pt-8 border-t border-slate-100">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 text-center">Nível de Autoridade</p>
                        <div id="badge-config" class="text-center py-4 rounded-3xl font-black text-sm border uppercase tracking-widest"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, setDoc, getDoc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhebhWNET0qK1yA09WYiGayg2vp6fZtmE",
            authDomain: "site-administrativo.firebaseapp.com",
            projectId: "site-administrativo",
            storageBucket: "site-administrativo.firebasestorage.app",
            messagingSenderId: "168715430420",
            appId: "1:168715430420:web:17c799ab344c008c4dd501"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // --- IDENTIFICAÇÃO DO MESTRE ---
        const RAFAEL_EMAIL = "rafaelmartinsdosanjos27@gmail.com";

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);
        
        window.showTab = (name) => {
            ['home', 'afiliacoes', 'config', 'admin-master'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
        };

        const getBadgeStyle = (cargo) => {
            const st = {
                criador: "bg-purple-100 text-purple-700 border-purple-200",
                admin: "bg-red-100 text-red-700 border-red-200",
                suport: "bg-blue-100 text-blue-700 border-blue-200",
                verificado: "bg-emerald-100 text-emerald-700 border-emerald-200",
                minimo: "bg-slate-100 text-slate-500 border-slate-200"
            };
            return st[cargo] || st.minimo;
        };

        // --- MANUTENÇÃO ---
        onSnapshot(doc(db, "configuracoes", "geral"), (snap) => {
            if (snap.exists() && snap.data().manutencao === true && auth.currentUser?.email !== RAFAEL_EMAIL) {
                document.getElementById('overlay-manutencao').classList.remove('hidden');
            } else {
                document.getElementById('overlay-manutencao').classList.add('hidden');
            }
        });

        window.alternarManutencao = async (status) => {
            await setDoc(doc(db, "configuracoes", "geral"), { manutencao: status });
            alert(status ? "SISTEMA BLOQUEADO" : "SISTEMA LIBERADO");
        };

        // --- CARGOS ---
        window.alterarCargo = async (uid, novoCargo) => {
            if(confirm(`Mudar nível para ${novoCargo.toUpperCase()}?`)) {
                await updateDoc(doc(db, "usuarios", uid), { cargo: novoCargo });
            }
        };

        const carregarGestaoCargos = () => {
            onSnapshot(collection(db, "usuarios"), (snap) => {
                const lista = document.getElementById('lista-gestao-cargos');
                lista.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    const cargo = u.cargo || "minimo";
                    lista.innerHTML += `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-6">
                                <div class="font-bold text-slate-800">${u.nome}</div>
                                <div class="text-[10px] text-slate-400 font-medium">${u.email}</div>
                            </td>
                            <td class="p-6"><span class="px-3 py-1 rounded-full text-[9px] font-black border ${getBadgeStyle(cargo)}">${cargo.toUpperCase()}</span></td>
                            <td class="p-6 text-right">
                                <select onchange="alterarCargo('${d.id}', this.value)" class="text-[10px] border p-2 rounded-xl bg-white shadow-sm outline-none">
                                    <option value="minimo" ${cargo === 'minimo' ? 'selected' : ''}>MÍNIMO</option>
                                    <option value="verificado" ${cargo === 'verificado' ? 'selected' : ''}>VERIFICADO</option>
                                    <option value="suport" ${cargo === 'suport' ? 'selected' : ''}>SUPORTE</option>
                                    <option value="admin" ${cargo === 'admin' ? 'selected' : ''}>ADMIN</option>
                                    <option value="criador" ${cargo === 'criador' ? 'selected' : ''}>CRIADOR</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });
            });
        };

        // --- PRODUTOS ---
        window.salvarProduto = async () => {
            const nome = document.getElementById('prod-nome').value;
            const preco = document.getElementById('prod-preco').value;
            if(!nome || !preco) return;
            await addDoc(collection(db, "produtos"), { nome, precoOriginal: Number(preco), autor: auth.currentUser.email, data: new Date() });
            document.getElementById('prod-nome').value = ""; document.getElementById('prod-preco').value = "";
        };

        window.removerProduto = async (id) => {
            if(confirm("Remover permanentemente?")) await deleteDoc(doc(db, "produtos", id));
        };

        onSnapshot(collection(db, "produtos"), (snapshot) => {
            const grid = document.getElementById('grid-produtos');
            grid.innerHTML = "";
            snapshot.forEach(docSnap => {
                const p = docSnap.data();
                const id = docSnap.id;
                // Só quem tem cargo alto pode deletar
                const showDelete = auth.currentUser?.email === RAFAEL_EMAIL;
                grid.innerHTML += `
                    <div class="bg-white rounded-[40px] shadow-sm border border-slate-200 p-8 relative hover:shadow-xl transition-all group">
                        ${showDelete ? `<button onclick="removerProduto('${id}')" class="absolute top-6 right-6 text-slate-200 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>` : ''}
                        <h4 class="font-black text-2xl text-slate-800 mb-2">${p.nome}</h4>
                        <p class="text-slate-400 text-sm mb-6 line-through italic font-medium">De R$ ${p.precoOriginal},00</p>
                        <div class="bg-blue-50/50 p-6 rounded-3xl mb-6 border border-blue-100 group-hover:bg-blue-600 group-hover:text-white transition-all">
                            <p class="text-[10px] font-black uppercase mb-1 opacity-70">Sua Comissão</p>
                            <p class="font-black text-3xl italic">R$ 50,00</p>
                        </div>
                        <button onclick="seAfiliar('${id}', '${p.nome}')" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl hover:bg-blue-600 transition-all shadow-lg active:scale-95">SE AFILIAR</button>
                    </div>
                `;
            });
        });

        window.seAfiliar = async (id, nome) => {
            await addDoc(collection(db, "afiliacoes"), { emailAfiliado: auth.currentUser.email, produtoId: id, produtoNome: nome, data: new Date() });
            alert(`Sucesso! ${nome} agora está na sua lista.`);
        };

        // --- AUTH E INICIALIZAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "usuarios", user.uid);
                
                // GARANTIA MESTRE: Força você como Criador no banco
                if (user.email === RAFAEL_EMAIL) {
                    await setDoc(userRef, { nome: user.displayName, email: user.email, cargo: "criador", photo: user.photoURL }, { merge: true });
                } else {
                    const snap = await getDoc(userRef);
                    if(!snap.exists()) await setDoc(userRef, { nome: user.displayName, email: user.email, cargo: "minimo", photo: user.photoURL });
                }

                const userData = (await getDoc(userRef)).data();
                const cargo = userData.cargo || "minimo";

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                document.getElementById('conf-name').innerText = user.displayName;
                document.getElementById('conf-email').innerText = user.email;
                document.getElementById('conf-photo').src = user.photoURL;

                // UI POR CARGO
                if(['criador', 'admin', 'verificado'].includes(cargo)) document.getElementById('admin-panel').classList.remove('hidden');
                if(['criador', 'admin', 'suport'].includes(cargo)) {
                    document.getElementById('btn-admin-master').classList.remove('hidden');
                    carregarGestaoCargos();
                }

                const badgeSidebar = document.getElementById('user-status-sidebar');
                badgeSidebar.className = `mt-2 text-[10px] font-black px-3 py-1 rounded-lg uppercase border ${getBadgeStyle(cargo)}`;
                badgeSidebar.innerText = cargo;

                const badgeConfig = document.getElementById('badge-config');
                badgeConfig.className = `text-center py-4 rounded-3xl font-black text-sm border uppercase tracking-widest ${getBadgeStyle(cargo)}`;
                badgeConfig.innerText = `Nível: ${cargo}`;

                // Lista de Afiliações
                onSnapshot(query(collection(db, "afiliacoes"), where("emailAfiliado", "==", user.email)), snap => {
                    const container = document.getElementById('lista-afiliacoes');
                    container.innerHTML = "";
                    snap.forEach(d => {
                        container.innerHTML += `<div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm font-black text-slate-700 flex items-center justify-between"><i class="fas fa-check-circle text-emerald-500"></i> ${d.data().produtoNome}</div>`;
                    });
                });

            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });
    </script>
</body>
</html>